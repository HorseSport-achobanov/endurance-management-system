@using Common.Domain;
@using EMS.Domain.Objects;
@using EMS.Domain.Setup.Entities;
@using EMS.Judge.Setup;
@using EMS.Judge.Setup.Events;
@using EMS.Judge.Setup.Staff;
@using EMS.Judge.UI.Contexts;
@using EMS.Judge.UI.Pages.Setup.Officials;
@using Not.Blazor.Dialogs;
@inject INotDialogService<Event, EventCreateModel, EventFields> _notDialogService;
@inject IRepository<Event> _repository;

@if (_model == null)
{
    <MudPaper>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RenderCreate">Create</MudButton>
    </MudPaper>
}
else
{
    <EditForm Model="_model" OnSubmit="this.Update">
        <DataAnnotationsValidator />

        <MudCard>
            <EventFields Model="_model" />
        </MudCard>
    </EditForm>
    
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Update">Update</MudButton>

    <MudPaper>
        <OfficialList />
    </MudPaper>
}

@code {
    private EventUpdateModel _model = default!;

    protected override async Task OnInitializedAsync()
    {
        var entity = await _repository.Read(0);
        if (entity == null)
        {
            return;
        }
        _model = new(entity);
    }

    protected async Task Update()
    {
        var entity = CreateEvent(_model);
        await _repository.Update(entity);
    }

    private async Task RenderCreate()
    {
        await _notDialogService.CreateEntity(CreateEvent);
        await OnInitializedAsync();
    }

    private Event CreateEvent(IEventForm input) => new Event(input.Place!, input.Country!);
}