@using System.Timers
@using System.Diagnostics
@inherits NotComponent
@implements IDisposable

<MudText Color="_color">
    @_displayTime
</MudText>

@code {
    [Parameter]
    public DateTime StartTime { get; set; } = default!;
    [Parameter]
    public double StopTimerAtTime { get; set; } = default!;

    TimeSpan TimerInterval = TimeSpan.FromSeconds(1);
    TimeSpan NegativeSecond = TimeSpan.FromSeconds(-1);
    TimeSpan FiveMinutes = TimeSpan.FromMinutes(5);

    private Timer _timer = default!;
    private MudTheme _theme = new MudTheme();
    private TimeSpan _time = default!;
    private string _displayTime = default!;
    private Color _color = default!;

    protected override void OnInitialized()
    {
        _timer = new Timer(TimerInterval);
        _timer.Elapsed += OnTimerElapsed;
        _timer.AutoReset = (_time > TimeSpan.FromMinutes(StopTimerAtTime));
    }

    protected override void OnParametersSet()
    {
        var now = DateTime.Now.TimeOfDay;
        _time = StartTime.TimeOfDay - now;
        FormatTime();
        _timer.Enabled = _time > TimeSpan.FromMinutes(StopTimerAtTime);
    }

    private async void OnTimerElapsed(object? sender, System.Timers.ElapsedEventArgs e)
    {
        _time = _time.Subtract(TimerInterval);
        FormatTime();
        if (_time <= TimeSpan.FromMinutes(StopTimerAtTime))
        {
            _timer.Enabled = false;
        }
        await Render();
    }

    private void FormatTime()
    {        
        if (_time >= TimeSpan.Zero)
        {
            _displayTime = $"{_time:hh\\:mm\\:ss}";
        }
        else
        {
            var positiveSignedTime = _time.Negate();            
            var isTrulyNegativeTime = _time <= NegativeSecond;
            _displayTime = isTrulyNegativeTime 
            ? " - " + $"{positiveSignedTime:hh\\:mm\\:ss}" 
            : $"{positiveSignedTime:hh\\:mm\\:ss}";
        }
        if (_time > FiveMinutes)
        {
            _color = Color.Success;
        }
        else if (_time >= TimeSpan.Zero)
        {
            _color = Color.Warning;
        }
        else
        {
            _color = Color.Error;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}